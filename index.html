<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DUWELL Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&family=Noto+Sans+KR:wght@100;300;400;500;700;900&family=Black+Han+Sans&family=Do+Hyeon&family=Jua&family=Nanum+Pen+Script&family=Gugi&family=Yeon+Sung&family=East+Sea+Dokdo&family=Gamja+Flower&family=Sunflower:wght@300;500;700&family=Gaegu&family=Poor+Story&family=Song+Myung&family=Stylish&display=swap" rel="stylesheet">
    <style>
        :root { --duwell-wine: #800020; --towel-color: #ffffff; --towel-texture: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMiIvPgo8Y2lyY2xlIGN4PSIyIiBjeT0iMiIgcj0iMSIgZmlsbD0iIzAwMCIgZmlsbC1vcGFjaXR5PSIwLjEiLz4KPC9zdmc+'); }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Noto Sans KR', sans-serif; background: #e0e4e8; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .container { display: flex; width: 100%; height: 100%; }
        
        #kakaotalk-banner {
            display: none; position: fixed; top: 0; left: 0; width: 100%; background: #fee500; 
            color: #3c1e1e; padding: 12px; z-index: 20000; font-size: 13px; font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); align-items: center; justify-content: space-between;
        }
        #kakaotalk-banner button {
            background: #3c1e1e; color: #fee500; border: none; padding: 5px 10px; 
            border-radius: 4px; font-weight: bold; cursor: pointer; margin-left: 10px;
        }

        #customPopup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center; }
        .popup-content { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .popup-title { font-size: 18px; font-weight: 900; color: var(--duwell-wine); margin-bottom: 10px; }
        .popup-msg { font-size: 14px; color: #555; margin-bottom: 20px; line-height: 1.5; }
        .popup-btn { background: var(--duwell-wine); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%; font-size: 15px; }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--duwell-wine); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .sidebar { width: 420px; background: white; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 10; }
        .workspace { flex: 1; background-color: #d1d8e0; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .logo { color: var(--duwell-wine); font-size: 24px; font-weight: 900; text-align: center; border-bottom: 2px solid var(--duwell-wine); padding-bottom: 10px; margin: 0; }
        .group { padding-bottom: 15px; border-bottom: 1px solid #eee; }
        label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 14px; color: #333; }
        .input-field { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .action-btn { width: 100%; padding: 16px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; font-size: 16px; background: var(--duwell-wine); color: white; margin-top: 5px; box-shadow: 0 4px 6px rgba(128,0,32,0.2); }
        .towel-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size:14px; }
        .item-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; max-height: 180px; overflow-y: auto; padding: 5px; background: #f9f9f9; border-radius: 8px; }
        .item-btn { padding: 12px 10px; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 13px; border-radius: 6px; text-align: center; }
        .icon-btn { padding: 10px; border: 1px solid #eee; background: white; cursor: pointer; border-radius: 6px; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 12px; }
        .icon-btn svg { width: 28px; height: 28px; fill: #333; }
        .photo-btn { background: #34495e; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .product-select { width: 100%; padding: 14px; border: 2px solid var(--duwell-wine); border-radius: 8px; font-size: 14px; font-weight: bold; color: #333; cursor: pointer; background: #fff; }
        .towel-option { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #ddd; cursor: pointer; background-image: var(--towel-texture); background-blend-mode: multiply; position: relative; }
        .towel-option.active { border-color: var(--duwell-wine); transform: scale(1.15); border-width: 3px; z-index: 2; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        .price-box { background: #fffafb; padding: 15px; border-radius: 8px; border: 2px solid var(--duwell-wine); text-align: right; margin-top: 10px; }
        .price-total { font-size: 22px; font-weight: 900; color: var(--duwell-wine); margin-top: 5px; }
        .price-info { font-size: 13px; color: #555; margin-bottom: 5px; font-weight: bold; }
        .price-warning { color: #e74c3c; font-size: 11px; font-weight: bold; margin-top: 8px; display: none; background: #fff; padding: 5px; border-radius: 4px; border: 1px solid #ffcccc; text-align: center; }
        .mockup-wrapper { width: 100%; display: flex; justify-content: center; align-items: center; }
        #towelMockup { width: 900px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .terry-texture { background-color: var(--towel-color); background-image: var(--towel-texture); background-blend-mode: multiply; }
        .towel-top { width: 100%; height: 70px; border-radius: 12px 12px 0 0; }
        .towel-bottom { width: 100%; height: 90px; border-radius: 0 0 12px 12px; }
        .canvas-band-wrapper { width: 100%; display: flex; justify-content: center; position: relative; }
        .mode-print .canvas-band-wrapper { background: #ffffff; padding: 4px 0; box-shadow: inset 0 4px 6px rgba(0,0,0,0.1); }
        .mode-embroidery .embroidery-bg { display: block; position: absolute; top:0; left:0; width:100%; height:100%; }
        .preview-text { margin-top: 20px; font-weight: bold; font-size: 15px; color: #333; background: rgba(255,255,255,0.7); padding: 5px 15px; border-radius: 20px; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        @media (max-width: 768px) {
            body { display: block; overflow-y: auto; height: auto; }
            .container { flex-direction: column-reverse; height: auto; display: flex; }
            .workspace { position: sticky; top: 0; z-index: 90; height: 220px; padding-top: 40px; padding-bottom: 20px; border-bottom: 2px solid var(--duwell-wine); box-shadow: 0 5px 15px rgba(0,0,0,0.15); background-color: #d1d8e0; }
            .preview-text { display: none; } 
            .mockup-wrapper { transform: scale(0.38); transform-origin: top center; height: 100px; }
            .sidebar { width: 100%; padding: 15px; box-shadow: none; z-index: 10; overflow-y: visible; }
            .towel-option { width: 42px; height: 42px; }
            .item-grid { grid-template-columns: repeat(3, 1fr); max-height: 220px; }
            .action-btn { font-size: 18px; padding: 18px; }
            #kakaotalk-banner { padding-top: env(safe-area-inset-top); } 
        }
    </style>
</head>
<body>

<div id="kakaotalk-banner">
    âš ï¸ ì¹´ì¹´ì˜¤í†¡ì—ì„œëŠ” ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆì–´ìš”!
    <button onclick="copyCurrentLink()">ğŸ”— ì£¼ì†Œ ë³µì‚¬ (Safarië¡œ ì—´ê¸°)</button>
</div>

<div id="customPopup">
    <div class="popup-content">
        <div class="popup-title" id="popupTitle">ì•Œë¦¼</div>
        <div class="popup-msg" id="popupMsg">ë‚´ìš©</div>
        <button class="popup-btn" onclick="closePopup()">í™•ì¸</button>
    </div>
</div>

<div id="loading">
    <div class="loader"></div>
    <h3 style="color:var(--duwell-wine);">DUWELL STUDIO</h3>
    <p style="font-size:14px; color:#555;">ìµœì‹  ê°€ê²© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</p>
</div>

<div class="container">
    <div class="sidebar">
        <h1 class="logo">DUWELL STUDIO</h1>
        
        <div class="group"><label>1ï¸âƒ£ ì œí’ˆ ì„ íƒ (ë¼ì¸ì—…)</label><select id="productSelect" class="product-select" onchange="changeProduct()"></select></div>
        <div class="group"><label>2ï¸âƒ£ ìƒ‰ìƒ ì„ íƒ</label><div id="towel-grid" style="display:flex; flex-wrap:wrap; gap:10px;"></div></div>
        <div class="group"><label>ğŸ› ï¸ ì œì‘ ë°©ì‹</label><div style="display:flex; gap:10px; background:#f0f0f0; padding:5px; border-radius:10px;"><button id="btn-p" class="towel-btn" onclick="setMode('print')">ğŸ–¨ï¸ ì „ì‚¬</button><button id="btn-e" class="towel-btn" onclick="setMode('embroidery')">ğŸ§µ ììˆ˜</button></div></div>
        <div class="group"><label>ğŸ í¬ì¥ ì˜µì…˜ ì„ íƒ</label><select id="packagingSelect" class="product-select" onchange="calcPrice()"></select></div>
        <div class="group"><label>ğŸ“¸ ë‚´ ì‚¬ì§„/ë¡œê³  ë„£ê¸°</label><button class="photo-btn" onclick="document.getElementById('upload').click()">ğŸ“‚ ê°¤ëŸ¬ë¦¬ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button><input type="file" id="upload" accept="image/*" style="display:none"></div>
        
        <div class="group"><label>âœ¨ ì‹¬ë³¼ ì•„ì´ì½˜ (20ì¢…)</label><div id="icon-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; max-height: 180px; overflow-y:auto; padding:2px;"></div></div>
        <div class="group"><label>ğŸ”¤ í°íŠ¸ & ì»¬ëŸ¬</label><div id="font-grid" class="item-grid"></div><input type="color" id="textColorPicker" value="#333333" oninput="changeTextColor(this.value)" style="width:100%; height:45px; border:none; margin-top:10px; cursor:pointer; border-radius:5px;"></div>
        
        <div class="group"><label>ğŸ“ í¸ì§‘ ë„êµ¬</label><div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:6px;"><button class="item-btn" onclick="alignObj('left')">ì¢Œì¸¡</button><button class="item-btn" onclick="alignObj('centerH')">ê°€ìš´ë°</button><button class="item-btn" onclick="alignObj('right')">ìš°ì¸¡</button><button class="item-btn" onclick="alignObj('centerFull')" style="color:var(--duwell-wine); font-weight:bold;">ì •ì¤‘ì•™</button><button class="item-btn" onclick="changeLayer('front')">ì•ìœ¼ë¡œ</button><button class="item-btn" onclick="changeLayer('back')">ë’¤ë¡œ</button><button class="item-btn" style="color:red; grid-column: span 3; font-weight:bold;" onclick="deleteObj()">ì„ íƒ ì‚­ì œ (Del)</button></div></div>

        <div class="group" style="background:#fffafb; border: 2px solid var(--duwell-wine); border-radius:10px; padding:15px; margin-top:20px;">
            <label style="color:var(--duwell-wine); font-size:16px;">ğŸ“ ìµœì¢… ì£¼ë¬¸ì„œ ì‘ì„±</label>
            <input type="text" id="custName" placeholder="ì„±í•¨ (í•„ìˆ˜)" class="input-field">
            <input type="tel" id="custPhone" placeholder="ì—°ë½ì²˜ (í•„ìˆ˜)" class="input-field">
            <input type="text" id="custAddress" placeholder="ë°°ì†¡ì§€ ì£¼ì†Œ (í•„ìˆ˜)" class="input-field">
            <label style="font-size:12px; margin-top:5px;">ğŸ“… í¬ë§ ìˆ˜ë ¹ì¼</label>
            <input type="date" id="custDeliveryDate" class="input-field">
            <hr style="margin: 15px 0; border:0; border-top:1px dashed #ddd;">
            <label style="color:#333;">ğŸ“¦ ìˆ˜ëŸ‰ ì…ë ¥ (ì¥)</label>
            <input type="number" id="custQty" placeholder="0" class="input-field" style="font-weight:bold; font-size:16px;" oninput="calcPrice()">
            <div class="price-box">
                <div class="price-info">ìˆ˜ê±´ ë‹¨ê°€: <span id="unitPriceDisplay">0</span>ì›</div>
                <div class="price-info" id="packPriceInfo" style="display:none; color:#2980b9;">+ í¬ì¥ë¹„: <span id="packCostDisplay">0</span>ì›</div>
                <div id="displayPrice" class="price-total">0ì›</div>
                <div id="embroideryWarning" class="price-warning">â€» ììˆ˜ëŠ” ë„ì•ˆ ì¹¨ìˆ˜(ë³µì¡ë„)ì— ë”°ë¼<br>ìµœì¢… ê¸ˆì•¡ì´ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
            <button class="action-btn" onclick="sendDataToGoogleSheet()">ì£¼ë¬¸ ì „ì†¡í•˜ê¸°</button>
        </div>
    </div>

    <div class="workspace">
        <div class="mockup-wrapper">
            <div id="towelMockup" class="mode-print">
                <div class="towel-body towel-top terry-texture"></div>
                <div class="band-container" style="width:100%; position:relative; z-index:1;">
                    <div class="embroidery-bg terry-texture" style="display:none;"></div>
                    <div class="canvas-band-wrapper"><canvas id="mainCanvas"></canvas></div>
                </div>
                <div class="towel-body towel-bottom terry-texture"></div>
            </div>
        </div>
        <p class="preview-text">â— <span id="modeText">ì „ì‚¬ ì¸ì‡„ (í™”ì´íŠ¸ ë°´ë“œ)</span> ë¯¸ë¦¬ë³´ê¸°</p>
    </div>
</div>

<script>
    // ğŸ”” [ì£¼ì†Œ í™•ì¸] ì‚¬ì¥ë‹˜ì˜ GAS ì£¼ì†Œê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyBCyLgcfEqTXTWmDeGcuw2ib2yDmSYEONpHGlLmZWZjKV17nUgD8CVjn12sQv-VnVF/exec'; 

    const canvas = new fabric.Canvas('mainCanvas', { width: 866, height: 100, backgroundColor: '#ffffff', preserveObjectStacking: true });
    let currentMode = 'print', currentTowelColor = '#ffffff', guide;
    let currentPrice = 0, selectedProductName = "", packagingCost = 0;
    let productData = [], packagingData = [];

    if (navigator.userAgent.match(/KAKAOTALK/i)) {
        document.getElementById('kakaotalk-banner').style.display = 'flex';
    }

    function copyCurrentLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert("ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! \nSafari(ì‚¬íŒŒë¦¬)ë‚˜ Chrome(í¬ë¡¬)ì„ ì—´ê³  ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.");
        }).catch(() => {
            prompt("ì•„ë˜ ì£¼ì†Œë¥¼ ë³µì‚¬í•´ì„œ Safariì—ì„œ ì—´ì–´ì£¼ì„¸ìš”:", url);
        });
    }

    function showPopup(title, msg) {
        document.getElementById('popupTitle').innerText = title;
        document.getElementById('popupMsg').innerHTML = msg;
        document.getElementById('customPopup').style.display = 'flex';
    }
    function closePopup() { document.getElementById('customPopup').style.display = 'none'; }

    const iconPaths = {
        'í•˜íŠ¸': 'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z',
        'ë³„': 'M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z',
        'ì™•ê´€': 'M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z',
        'ìŠ¤ë§ˆì¼': 'M12 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z',
        'ì²´í¬': 'M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z',
        'ìë™ì°¨': 'M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99z',
        'íŠ¸ë¡œí”¼': 'M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94.63 1.5 1.98 2.63 3.61 2.96V19H7v2h10v-2h-4v-3.1c1.63-.33 2.98-1.46 3.61-2.96C19.08 10.63 21 8.55 21 8V7c0-1.1-.9-2-2-2zM5 8V7h2v3.82C5.84 10.4 5 9.3 5 8zm14 2.82c-.84.42-1.68.58-2 .63V7h2v1z',
        'ë¹„í–‰ê¸°': 'M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z',
        'ì¹´ë©”ë¼': 'M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9z',
        'í•´': 'M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1z',
        'ë‹¬': 'M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z',
        'êµ¬ë¦„': 'M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z',
        'ì§‘': 'M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z',
        'ì‚¼ê°í˜•': 'M12 2L2 22h20L12 2z',
        'ì›': 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z',
        'ì‚¬ê°í˜•': 'M3 3h18v18H3z',
        'ì‹­ìê°€': 'M11 2v6H5v4h6v10h4V12h6V8h-6V2z',
        'ìŒí‘œ': 'M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z',
        'ë‹¤ì´ì•„': 'M19 3H5L2 9l10 12L22 9l-3-6z',
        'ì„ ë¬¼': 'M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z'
    };

    async function fetchData() {
        try {
            // ğŸš¨ í•µì‹¬ ìˆ˜ì • 1: ?nocache=... ì¶”ê°€í•˜ì—¬ ë§¤ë²ˆ ìƒˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            const response = await fetch(scriptURL + "?nocache=" + new Date().getTime());
            const data = await response.json();
            productData = data.products;
            packagingData = data.packaging;
            init();
            document.getElementById('loading').style.display = 'none';
        } catch (error) {
            showPopup("ì˜¤ë¥˜", "ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
        }
    }

    function init() {
        guide = new fabric.Rect({ left: 5, top: 5, width: 856, height: 90, fill: 'transparent', stroke: '#800020', strokeDashArray: [4, 4], selectable: false, evented: false, opacity: 0.3 });
        canvas.add(guide);
        
        const ig = document.getElementById('icon-grid');
        Object.keys(iconPaths).forEach(n => {
            let b = document.createElement('button'); b.className='icon-btn'; b.onclick=()=>addIcon(n);
            b.innerHTML = `<svg viewBox="0 0 24 24"><path d="${iconPaths[n]}"></path></svg><span>${n}</span>`;
            ig.appendChild(b);
        });

        const fg = document.getElementById('font-grid');
        ['Noto Sans KR', 'Nanum Myeongjo', 'Do Hyeon', 'Jua', 'Nanum Pen Script', 'Black Han Sans', 'Gugi', 'Yeon Sung', 'East Sea Dokdo', 'Gamja Flower', 'Poor Story', 'Gaegu', 'Sunflower', 'Song Myung', 'Stylish'].forEach(f => {
            let b = document.createElement('button'); b.className='item-btn'; b.style.fontFamily=f; b.onclick=()=>addText(f, 'DUWELL'); b.innerText=f; fg.appendChild(b);
        });

        const ps = document.getElementById('productSelect');
        ps.innerHTML = "";
        productData.forEach((p, index) => {
            let opt = document.createElement('option'); opt.value = index; opt.innerText = `${p.name} (${p.price.toLocaleString()}ì›)`; ps.appendChild(opt);
        });

        const packSel = document.getElementById('packagingSelect');
        packSel.innerHTML = "";
        packagingData.forEach((p, index) => {
            let opt = document.createElement('option'); opt.value = index; opt.innerText = `${p.name} (${p.price.toLocaleString()}ì›)`; packSel.appendChild(opt);
        });
        
        // ğŸš¨ í•µì‹¬ ìˆ˜ì • 2: ì…ë ¥ì°½ í´ë¦­ ì‹œ ìº”ë²„ìŠ¤ ì„ íƒ í•´ì œ (UX ê°œì„ )
        const inputs = document.querySelectorAll('.input-field');
        inputs.forEach(input => {
            input.addEventListener('focus', () => {
                canvas.discardActiveObject(); // ì„ íƒ í•´ì œ
                canvas.renderAll(); // í™”ë©´ ê°±ì‹ 
            });
        });

        changeProduct();
    }

    function changeProduct() {
        if(productData.length === 0) return;
        const index = document.getElementById('productSelect').value;
        const product = productData[index];
        currentPrice = product.price;
        selectedProductName = product.name;
        document.getElementById('unitPriceDisplay').innerText = currentPrice.toLocaleString();
        calcPrice();
        
        const tg = document.getElementById('towel-grid');
        tg.innerHTML = '';
        product.colors.forEach((c, idx) => {
            let d = document.createElement('div'); d.className='towel-option'; d.style.backgroundColor=c; d.onclick=()=>setTowel(c, d); tg.appendChild(d);
            if(idx === 0) setTowel(c, d);
        });
    }

    function calcPrice() {
        if(packagingData.length === 0) return;
        const qty = document.getElementById('custQty').value;
        const packIndex = document.getElementById('packagingSelect').value;
        packagingCost = packagingData[packIndex].price;
        const packInfo = document.getElementById('packPriceInfo'), packCostDisplay = document.getElementById('packCostDisplay');
        if (packagingCost > 0) { packInfo.style.display = 'block'; packCostDisplay.innerText = packagingCost.toLocaleString(); } else { packInfo.style.display = 'none'; }
        let total = 0; if (qty > 0) total = (currentPrice + packagingCost) * qty;
        document.getElementById('displayPrice').innerText = total.toLocaleString() + "ì›";
    }

    function setMode(m) {
        currentMode = m;
        const mock = document.getElementById('towelMockup'), txt = document.getElementById('modeText'), embBg = document.querySelector('.embroidery-bg'), btnP = document.getElementById('btn-p'), btnE = document.getElementById('btn-e'), warning = document.getElementById('embroideryWarning');
        if(m === 'print') { 
            mock.className='mode-print'; txt.innerText='ì „ì‚¬ ì¸ì‡„ (í™”ì´íŠ¸ ë°´ë“œ)'; embBg.style.display='none'; canvas.backgroundColor='#ffffff'; 
            btnP.style.background='var(--duwell-wine)'; btnP.style.color='white'; btnE.style.background='#fff'; btnE.style.color='#333'; warning.style.display = 'none';
        } else { 
            mock.className='mode-embroidery'; txt.innerText='ì»´í“¨í„° ììˆ˜ (ì¼ë°˜ ìˆ˜ê±´)'; embBg.style.display='block'; canvas.backgroundColor=null; 
            btnE.style.background='var(--duwell-wine)'; btnE.style.color='white'; btnP.style.background='#fff'; btnP.style.color='#333'; warning.style.display = 'block';
        }
        canvas.renderAll();
    }
    function setTowel(c, el) { currentTowelColor = c; document.documentElement.style.setProperty('--towel-color', c); document.querySelectorAll('.towel-option').forEach(t=>t.classList.remove('active')); if(el) el.classList.add('active'); setMode(currentMode); }
    function addText(f, t) { const it = new fabric.IText(t, { left: 100, top: 25, fontFamily: f, fontSize: 35, fill: document.getElementById('textColorPicker').value }); canvas.add(it).centerObject(it).setActiveObject(it); }
    function addIcon(n) { const p = new fabric.Path(iconPaths[n], { fill: document.getElementById('textColorPicker').value, scaleX: 1.5, scaleY: 1.5 }); canvas.add(p).centerObject(p).setActiveObject(p); }
    function changeTextColor(v) { const o = canvas.getActiveObject(); if (o) { o.set('fill', v); canvas.renderAll(); } }
    function alignObj(type) { const o = canvas.getActiveObject(); if(!o) return; if(type === 'left') o.set({ left: 10 }); else if(type === 'right') o.set({ left: canvas.width - o.getScaledWidth() - 10 }); else if(type === 'centerH') canvas.centerObjectH(o); else if(type === 'centerFull') canvas.centerObject(o); o.setCoords(); canvas.renderAll(); }
    function changeLayer(d) { const o = canvas.getActiveObject(); if(!o) return; if(d === 'front') o.bringForward(); else o.sendBackwards(); canvas.sendToBack(guide); canvas.renderAll(); }
    function deleteObj() { canvas.getActiveObjects().forEach(o => canvas.remove(o)); canvas.discardActiveObject().renderAll(); }
    
    // ğŸš¨ í•µì‹¬ ìˆ˜ì • 3: í‚¤ë³´ë“œ ì…ë ¥ ì‹œ ìº”ë²„ìŠ¤ ì‚­ì œ ë°©ì§€ (ì•ˆì „ì¥ì¹˜)
    window.addEventListener('keydown', (e) => {
        // ì…ë ¥ì°½ì´ë‚˜ í…ìŠ¤íŠ¸ë°•ìŠ¤ì—ì„œ íƒ€ì´í•‘ ì¤‘ì´ë©´ -> ì•„ë¬´ê²ƒë„ í•˜ì§€ ë§ê³  ë©ˆì¶¤
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // ê·¸ê²Œ ì•„ë‹ ë•Œë§Œ ì‚­ì œ ë™ì‘ ìˆ˜í–‰
        if((e.key==='Delete' || e.key==='Backspace') && canvas.getActiveObject() && !canvas.getActiveObject().isEditing) {
            deleteObj();
        }
    });

    document.getElementById('upload').onchange = (e) => { const r = new FileReader(); r.onload = (f) => { fabric.Image.fromURL(f.target.result, (img) => { img.scaleToHeight(80); canvas.add(img).centerObject(img); }); }; r.readAsDataURL(e.target.files[0]); };

    async function sendDataToGoogleSheet() {
        const name = document.getElementById('custName').value, phone = document.getElementById('custPhone').value, address = document.getElementById('custAddress').value, deliveryDate = document.getElementById('custDeliveryDate').value;
        const qty = document.getElementById('custQty').value, totalPrice = document.getElementById('displayPrice').innerText;
        const packIndex = document.getElementById('packagingSelect').value, packName = packagingData[packIndex].name;

        if(!name || !phone || !address) { showPopup("ì•Œë¦¼", "ì„±í•¨, ì—°ë½ì²˜, ì£¼ì†ŒëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤!"); return; }

        try {
            guide.visible = false;
            // ğŸš¨ ì•„ì´í° ë©”ëª¨ë¦¬ ìµœì í™” (í™”ì§ˆì„ 0.8ë¡œ ì•½ê°„ ë‚®ì¶°ì„œ íŠ•ê¹€ ë°©ì§€)
            const imageData = canvas.toDataURL({ format: 'png', multiplier: 2, quality: 0.8 }); 
            guide.visible = true; canvas.renderAll();

            const orderData = { name, phone, address, deliveryDate, quantity: qty, totalPrice: totalPrice, productName: selectedProductName, packaging: packName, image: imageData };
            
            showPopup("ì£¼ë¬¸ ì „ì†¡ ì¤‘", "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...<br>(ì•½ 3~5ì´ˆ ì†Œìš”)");
            
            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(orderData) });
            showPopup("âœ… ì£¼ë¬¸ ì™„ë£Œ!", "ì‚¬ì¥ë‹˜ê»˜ ì£¼ë¬¸ì„œê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.<br>í™•ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.");
        } catch(e) {
            showPopup("ì „ì†¡ ì˜¤ë¥˜", "ì¹´ì¹´ì˜¤í†¡ì—ì„œëŠ” ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ìƒë‹¨ì˜ <b>[ì£¼ì†Œ ë³µì‚¬]</b>ë¥¼ ëˆŒëŸ¬<br>Safariì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!");
        }
    }

    fetchData();
</script>
</body>
</html>
